# 浏览器的渲染原理详解

## 浏览器基本知识

### 主要组成部分

浏览器的主要组成部分如下：

- 浏览器引擎：在用户界面和渲染引擎之间传送指令
- 渲染引擎：负责显示请求的内容，如：请求内容是 HTML，渲染引擎就负责解析 HTML 和 CSS，并将解析的结果展示在屏幕上
- 网络：用于网络调用，如：HTTP 请求。
- JavaScript 解释器：用于解析和执行 JavaScript 代码
- 数据存储：浏览器需要在硬盘上保存的各种数据，如：Cookie、storage、indexdb。

### 浏览器内核

浏览器内核是`通过取得页面内容、整理信息（CSS）、计算和组合最终输出可视化图像结果`。

浏览器的内核是`多线程`的，在内核的控制下各个线程之间相互配合以保持同步，一个浏览器通常由以下常用线程组成：

- GUI 渲染线程：

负责渲染浏览器界面的 HTML 元素，当界面需要重绘或者回流的时候，该线程就会执行。在 JavaScript 引擎运行脚本时， GUI 渲染线程会被挂起，因此就出现了 JavaScript 脚本会阻塞 html 页面渲染的问题。

- JavaScript 引擎线程：

也被称为 js 内核，主要负责解析和执行 JavaScript 脚本，如：V8 引擎（JavaScript 是单线程的：TODO）

::: tip
GUI渲染线程与JS引擎线程互斥的，是由于JavaScript是可操纵DOM的，如果在修改这些元素属性同时渲染界面（即JavaScript线程和UI线程同时运行），那么渲染线程前后获得的元素数据就可能不一致。当JavaScript引擎执行时GUI线程会被挂起，GUI更新会被保存在一个队列中等到引擎线程空闲时立即被执行。由于GUI渲染线程与JS执行线程是互斥的关系，当浏览器在执行JS程序的时候，GUI渲染线程会被保存在一个队列中，直到JS程序执行完成，才会接着执行。因此如果JS执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞的感觉。
:::
- 定时器触发线程

浏览器定时计数器并不是由JS引擎计数的, 因为JS引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确, 因此通过单独线程来计时并触发定时是更为合理的方案。

- 事件触发线程

当一个事件被触发时该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理。这些事件可以是当前执行的代码块如定时任务、也可来自浏览器内核的其他线程如鼠标点击、AJAX异步请求等，但由于JS的单线程关系所有这些事件都得排队等待JS引擎处理。

- 异步 http 请求线程

在XMLHttpRequest在连接后是通过浏览器新开一个线程请求，将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件放到JS引擎的处理队列中等待处理。

## 网页的渲染流程

一个完整的网页渲染流程大致上可以概括为以下几点：

1. 解析
2. 计算 CSS 样式
3. 构建 Render Tree
4. 布局（layout)

    定位坐标和大小，是否换行，position, overflow之类的属性。确定了每个DOM元素的样式规则后，计算每个DOM元素最终在屏幕上显示的大小和位置。Web页面中元素的布局是相对的，因此一个元素的布局发生变化，会联动地引发其他元素的布局发生变化。比如body元素的width变化会影响其后代元素的宽度。因此，布局过程是经常发生的。

5. 绘制（paint）

    绘制文字、颜色、图像、边框和阴影等，也就是一个DOM元素所有的可视效果。一般来说，这个绘制过程是在多个层上完成的。

6. 渲染层合并（composite）

    页面中DOM元素的绘制是在多个层上进行的，在每个层上完成绘制过程之后，浏览器会将所有层按照合理的顺序合并成一个图层，然后在屏幕上呈现。

![浏览器渲染过程](./images/browser-xrlc.png)

## 1. 解析

### 解析 HTML 生成 DOM 树

获取请求文档的内容后，呈现引擎将开始解析 HTML 文档，并将各标记逐个转化成“内容树”上的 DOM 节点。

解析器解析html文档的解析树是由 DOM 元素和属性节点构成的树结构。它是 HTML 文档的对象表示，同时也是外部内容（例如 JavaScript）与 HTML 元素之间的api，其根节点是document。

解释html成dom的过程，由两个阶段组成：`标记化和树构建`。





### 解析 CSS 生成 CSSOM 树
### 解析 JavaScript
### 知识点一：重绘与回流

## 资料

- 🍃[浏览器进程？线程？傻傻分不清楚！](https://imweb.io/topic/58e3bfa845e5c13468f567d5)
- 🍃[浏览器原理](https://juejin.im/post/5b0a6f1af265da0ddb63ecd9#heading-27)